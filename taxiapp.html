<!DOCTYPE html>  
<html lang="ja">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">  
    <title>Taxi Pro</title>  
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />  
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>  
    <style>  
        body { margin: 0; padding: 0; background: #000; color: #fff; font-family: -apple-system, BlinkMacSystemFont, "Hiragino Kaku Gothic ProN", sans-serif; overflow: hidden; }  
        
        /* レイアウト全体 */  
        #map { height: 50vh; width: 100%; background: #111; }  
        #panel-area { height: 50vh; display: flex; flex-direction: column; background: #000; }  

        /* タブ切り替えボタン */  
        .tab-bar { display: flex; border-bottom: 1px solid #333; background: #111; flex-shrink: 0; }  
        .tab-btn {  
            flex: 1; padding: 12px 0; background: #111; color: #666; border: none;  
            font-size: 1rem; font-weight: bold; cursor: pointer; border-bottom: 3px solid transparent;  
        }  
        .tab-btn.active { color: #f1c40f; border-bottom-color: #f1c40f; background: #1a1a1a; }  

        /* コンテンツエリア */  
        #content-container { flex: 1; position: relative; overflow: hidden; }  
        #view-timetable, #view-history { width: 100%; height: 100%; position: absolute; top:0; left:0; }  
        
        /* --- 時刻表スタイル --- */  
        #view-timetable { overflow-y: auto; padding: 10px; box-sizing: border-box; }  
        .control-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }  
        .station-group { margin-bottom: 20px; border: 1px solid #333; border-radius: 8px; overflow: hidden; }  
        .station-header {  
            background: #1a1a1a; padding: 8px 12px; font-weight: bold; color: #eee;  
            display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333;  
        }  
        .train-row {  
            display: flex; justify-content: space-between; align-items: center;  
            padding: 10px 12px; border-bottom: 1px solid #1a1a1a; font-size: 0.95rem;  
        }  
        .train-time { color: #f1c40f; font-weight: bold; font-family: monospace; font-size: 1.2rem; }  
        
        /* --- 履歴リスト（横並びスタイル） --- */  
        #history-scroller {  
            display: flex;  
            overflow-x: auto; /* 横スクロール */  
            overflow-y: hidden;  
            height: 100%;  
            padding-bottom: env(safe-area-inset-bottom);  
        }  
        .day-column {  
            min-width: 140px; /* 列の幅 */  
            width: 140px;  
            border-right: 1px solid #333;  
            display: flex;  
            flex-direction: column;  
            background: #050505;  
        }  
        .day-header {  
            text-align: center; padding: 8px 0; font-weight: bold; font-size: 0.9rem;  
            background: #151515; border-bottom: 1px solid #333; color: #aaa; flex-shrink: 0;  
        }  
        .day-header.sunday { color: #e74c3c; }  
        .day-header.saturday { color: #3498db; }  
        .day-header.today { background: #333; color: #fff; }  

        .day-content {  
            flex: 1; overflow-y: auto; padding: 5px; /* 列の中は縦スクロール */  
        }  

        .log-card {  
            background: #1a1a1a; border: 1px solid #333; border-radius: 4px;  
            padding: 8px; margin-bottom: 8px; position: relative; cursor: pointer; /* クリックできる感 */  
            transition: background 0.2s;  
        }  
        .log-card:active { background: #333; }  
        .log-date-label { font-size: 0.7rem; color: #666; display: block; margin-bottom: 2px; }  
        .log-time { color: #f1c40f; font-family: monospace; font-size: 1.1rem; font-weight: bold; margin-right: 5px;}  
        .log-dest { display: block; font-weight: bold; font-size: 0.9rem; margin-top: 2px; color: #fff; }  
        .btn-card-del {  
            position: absolute; top: 5px; right: 5px;  
            background: none; border: none; color: #444; font-size: 1.2rem; line-height: 1; padding: 0; z-index: 10;  
        }  

        /* --- モーダルなど --- */  
        #modal-overlay {  
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;  
            background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center;  
        }  
        .modal-content { background: #222; padding: 25px; border-radius: 8px; width: 85%; max-width: 320px; }  
        input[type="text"], input[type="datetime-local"] {  
            width: 100%; padding: 12px; margin-bottom: 15px; box-sizing: border-box;  
            background: #333; border: 1px solid #555; color: #fff; font-size: 1rem; border-radius: 4px;  
        }  
        .modal-btns { display: flex; gap: 10px; }  
        .btn-cancel, .btn-save { flex: 1; padding: 12px; border: none; border-radius: 4px; font-weight: bold; font-size: 1rem; }  
        .btn-cancel { background: #444; color: #ccc; }  
        .btn-save { background: #f1c40f; color: #000; }  

        /* アイコン類 */  
        .station-icon {  
            background: #0d1b2a; color: #fff; border: 1px solid #fff; border-radius: 3px;  
            text-align: center; font-size: 10px; line-height: 18px; font-weight: bold;  
        }  
        .log-icon-dot {  
            background: #3498db; border: 2px solid #fff; border-radius: 50%;  
            box-shadow: 0 0 4px rgba(0,0,0,0.5);  
        }  
        .btn-mini { background:#333; color:#ccc; border:1px solid #555; padding:4px 8px; border-radius:4px; font-size:0.8rem;}  

        /* ポップアップ内のボタン */  
        .popup-btn-edit { background: #2ecc71; color: #fff; border: none; border-radius: 3px; margin-right: 5px; padding: 4px 8px;}  
        .popup-btn-del { background: #e74c3c; color: #fff; border: none; border-radius: 3px; padding: 4px 8px; }  
    </style>  
</head>  
<body>  

    <div id="map"></div>  
    
    <div id="panel-area">  
        <div class="tab-bar">  
            <button class="tab-btn active" onclick="switchTab('timetable')">時刻表</button>  
            <button class="tab-btn" onclick="switchTab('history')">履歴リスト</button>  
        </div>  
        
        <div id="content-container">  
            <!-- 時刻表ビュー -->  
            <div id="view-timetable">  
                <div class="control-bar">  
                    <span id="weather-info" style="color:#aaa; font-size:0.8rem">--</span>  
                    <button class="btn-mini" onclick="toggleEditMode()" id="edit-btn">時刻編集</button>  
                </div>  
                <div id="timetable-list"></div>  
            </div>  

            <!-- 履歴ビュー (横スクロール) -->  
            <div id="view-history" style="display:none;">  
                <div id="history-scroller">  
                    <!-- JSで日〜土の列を生成 -->  
                </div>  
            </div>  
        </div>  
    </div>  

    <!-- 入力モーダル -->  
    <div id="modal-overlay">  
        <div class="modal-content">  
            <label style="color:#aaa; font-size:0.8rem">行き先</label>  
            <input type="text" id="log-dest" placeholder="例: ○○病院">  
            <label style="color:#aaa; font-size:0.8rem">日時</label>  
            <input type="datetime-local" id="log-time">  
            <div class="modal-btns">  
                <button class="btn-cancel" onclick="closeModal()">キャンセル</button>  
                <button class="btn-save" onclick="saveLog()">記録する</button>  
            </div>  
        </div>  
    </div>  

    <script>  
        const DB_KEY_LOGS = 'taxi_logs_v4';  
        const DB_KEY_TIME = 'taxi_timetable_v2';  

        // 初期データ  
        const defaultTimetable = [  
            { id: 'fujisawa', name: '藤沢駅', url: 'https://transit.yahoo.co.jp/timetable/23304', trains: [{ l: 'JR下', d: '小田原', t: '00:30' }, { l: 'JR下', d: '平塚', t: '00:41' }, { l: '小田急', d: '江ノ島', t: '00:42' }] },  
            { id: 'tsujido', name: '辻堂駅', url: 'https://transit.yahoo.co.jp/timetable/23321/', trains: [{ l: 'JR下', d: '小田原', t: '00:34' }, { l: 'JR下', d: '平塚', t: '00:45' }] },  
            { id: 'chigasaki', name: '茅ヶ崎駅', url: 'https://transit.yahoo.co.jp/timetable/23249/', trains: [{ l: 'JR下', d: '小田原', t: '00:38' }, { l: '相模', d: '橋本', t: '23:42' }] },  
            { id: 'shonandai', name: '湘南台駅', url: 'https://transit.yahoo.co.jp/timetable/23366/', trains: [{ l: '小田急', d: '藤沢', t: '00:33' }, { l: '相鉄', d: '二俣川', t: '00:26' }] }  
        ];  
        let stationData = JSON.parse(localStorage.getItem(DB_KEY_TIME)) || defaultTimetable;  
        let isEditing = false;  

        // マップ初期化  
        const map = L.map('map', { zoomControl: false }).setView([35.3389, 139.4875], 12);  
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '' }).addTo(map);  
        const logsLayerGroup = L.layerGroup().addTo(map);  

        if (navigator.geolocation) {  
            navigator.geolocation.watchPosition(pos => {  
                const lat = pos.coords.latitude; const lon = pos.coords.longitude;  
                if(window.curPos) map.removeLayer(window.curPos);  
                window.curPos = L.circleMarker([lat, lon], { color: '#2ed573', radius: 6, fillOpacity: 1 }).addTo(map);  
                getWeather(lat, lon);  
            });  
        }  

        const stations = [  
            {lat:35.3389, lon:139.4875, id:'fujisawa', name:'藤沢'}, {lat:35.3368, lon:139.4473, id:'tsujido', name:'辻堂'},  
            {lat:35.3304, lon:139.4068, id:'chigasaki', name:'茅ヶ崎'}, {lat:35.3965, lon:139.4664, id:'shonandai', name:'湘南台'}  
        ];  
        stations.forEach(s => {  
            const icon = L.divIcon({ className: 'station-icon', html: s.name, iconSize: [40, 18] });  
            L.marker([s.lat, s.lon], {icon: icon}).addTo(map).on('click', () => {  
                switchTab('timetable');  
                setTimeout(() => document.getElementById(`st-${s.id}`).scrollIntoView({ behavior: 'smooth' }), 100);  
            });  
        });  

        // ログ機能  
        let tempLatLng = null;  
        const modal = document.getElementById('modal-overlay');  
        const tInput = document.getElementById('log-time');  
        const dInput = document.getElementById('log-dest');  

        map.on('click', function(e) {  
            tempLatLng = e.latlng;  
            const now = new Date();  
            const offset = now.getTimezoneOffset() * 60000;  
            tInput.value = (new Date(now - offset)).toISOString().slice(0, 16);  
            dInput.value = "";  
            modal.style.display = 'flex';  
            setTimeout(() => dInput.focus(), 100);  
        });  

        window.saveLog = function() {  
            if(!dInput.value) { alert("行き先を入れてください"); return; }  
            const dateObj = new Date(tInput.value);  
            const newLog = { lat: tempLatLng.lat, lon: tempLatLng.lng, note: dInput.value, ts: dateObj.toISOString() };  
            let logs = getLogs();  
            logs.push(newLog);  
            localStorage.setItem(DB_KEY_LOGS, JSON.stringify(logs));  
            renderMapPins();  
            renderWeekColumns(); // 更新  
            closeModal();  
        };  

        function getLogs() { return JSON.parse(localStorage.getItem(DB_KEY_LOGS)) || []; }  

        function renderMapPins() {  
            logsLayerGroup.clearLayers();  
            const logs = getLogs();  
            logs.forEach((log, idx) => {  
                const icon = L.divIcon({ className: 'log-icon-dot', iconSize: [14, 14] });  
                const m = L.marker([log.lat, log.lon], {icon: icon});  
                const d = new Date(log.ts);  
                const dateStr = `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`;  
                
                // 編集・削除ボタン付きのポップアップ  
                const popupContent = `  
                    <div style="text-align:center">  
                        <strong>${log.note}</strong><br>  
                        <span style="font-size:0.8rem;color:#666">${dateStr}</span><br>  
                        <div style="margin-top:5px;">  
                            <button class="popup-btn-edit" onclick="editLog(${idx})">編集</button>  
                            <button class="popup-btn-del" onclick="deleteLog(${idx})">削除</button>  
                        </div>  
                    </div>`;  
                m.bindPopup(popupContent);  
                logsLayerGroup.addLayer(m);  
            });  
        }  

        // --- 曜日別カラム表示 ---  
        function renderWeekColumns() {  
            const scroller = document.getElementById('history-scroller');  
            scroller.innerHTML = ''; // リセット  

            const logs = getLogs();  
            logs.sort((a, b) => new Date(b.ts) - new Date(a.ts));  

            const days = ['日', '月', '火', '水', '木', '金', '土'];  
            const todayIndex = new Date().getDay();  

            for(let i=0; i<7; i++) {  
                const col = document.createElement('div');  
                col.className = 'day-column';  
                let headerClass = 'day-header';  
                if(i === 0) headerClass += ' sunday';  
                if(i === 6) headerClass += ' saturday';  
                if(i === todayIndex) headerClass += ' today';  
                
                col.innerHTML = `<div class="${headerClass}">${days[i]}</div><div class="day-content" id="day-col-${i}"></div>`;  
                scroller.appendChild(col);  
            }  

            logs.forEach((log, idx) => {  
                const originalIdx = getLogs().findIndex(l => l.ts === log.ts && l.note === log.note);  
                const d = new Date(log.ts);  
                const dayIndex = d.getDay();  
                const targetContainer = document.getElementById(`day-col-${dayIndex}`);  
                
                const timeStr = `${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`;  
                const dateLabel = `${d.getMonth()+1}/${d.getDate()}`;  

                const card = document.createElement('div');  
                card.className = 'log-card';  
                card.innerHTML = `  
                    <span class="log-date-label">${dateLabel}</span>  
                    <span class="log-time">${timeStr}</span>  
                    <span class="log-dest">${log.note}</span>  
                    <button class="btn-card-del" id="del-btn-${originalIdx}">×</button>  
                `;  
                
                // クリックイベント: カード本体なら地図移動、×ボタンなら削除  
                card.onclick = (e) => {  
                    if (e.target.id === `del-btn-${originalIdx}`) {  
                        deleteLog(originalIdx);  
                    } else {  
                        jumpToLog(log.lat, log.lon);  
                    }  
                };  

                targetContainer.appendChild(card);  
            });  
        }  

        // 地図へジャンプ  
        window.jumpToLog = function(lat, lon) {  
            map.flyTo([lat, lon], 16, { duration: 1.5 });  
        };  

        // ログ編集  
        window.editLog = function(idx) {  
            let logs = getLogs();  
            const currentNote = logs[idx].note;  
            const newNote = prompt("行き先を修正:", currentNote);  
            if (newNote !== null && newNote !== "") {  
                logs[idx].note = newNote;  
                localStorage.setItem(DB_KEY_LOGS, JSON.stringify(logs));  
                renderMapPins();  
                renderWeekColumns();  
                map.closePopup();  
            }  
        };  

        window.deleteLog = function(idx) {  
            if(!confirm("削除しますか？")) return;  
            let logs = getLogs();  
            logs.splice(idx, 1);  
            localStorage.setItem(DB_KEY_LOGS, JSON.stringify(logs));  
            renderMapPins();  
            renderWeekColumns();  
            map.closePopup();  
        };  

        // --- UI切り替え ---  
        window.switchTab = function(tabName) {  
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));  
            document.getElementById('view-timetable').style.display = 'none';  
            document.getElementById('view-history').style.display = 'none';  
            
            if(tabName === 'timetable') {  
                document.querySelector('.tab-btn:nth-child(1)').classList.add('active');  
                document.getElementById('view-timetable').style.display = 'block';  
            } else {  
                document.querySelector('.tab-btn:nth-child(2)').classList.add('active');  
                document.getElementById('view-history').style.display = 'block';  
                renderWeekColumns();  
            }  
        };  

        window.closeModal = () => modal.style.display = 'none';  

        function renderTimetable() {  
            const container = document.getElementById('timetable-list');  
            container.innerHTML = '';  
            stationData.forEach((st, sIdx) => {  
                let rows = '';  
                st.trains.forEach((tr, tIdx) => {  
                    const tDisp = isEditing   
                        ? `<input type="time" style="width:80px; padding:2px;" value="${tr.t}" onchange="updateTime(${sIdx},${tIdx},this.value)">`   
                        : `<span class="train-time">${tr.t}</span>`;  
                    rows += `<div class="train-row"><span style="color:#888; font-size:0.8rem; width:30%">${tr.l}</span><span style="width:40%">${tr.d}</span>${tDisp}</div>`;  
                });  
                container.innerHTML += `<div class="station-group" id="st-${st.id}"><div class="station-header">${st.name} <a href="${st.url}" target="_blank" style="color:#3498db; font-size:0.8rem; text-decoration:none;">Yahoo!</a></div>${rows}</div>`;  
            });  
        }  
        
        window.updateTime = (sIdx, tIdx, val) => stationData[sIdx].trains[tIdx].t = val;  
        window.toggleEditMode = () => {  
            isEditing = !isEditing;  
            document.getElementById('edit-btn').innerText = isEditing ? "完了" : "時刻編集";  
            if(!isEditing) localStorage.setItem(DB_KEY_TIME, JSON.stringify(stationData));  
            renderTimetable();  
        };  

        async function getWeather(lat, lon) {  
            try {  
                const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);  
                const d = await r.json();  
                document.getElementById('weather-info').innerText = `${d.current_weather.temperature}℃`;  
            } catch(e){}  
        }  

        renderTimetable();  
        renderMapPins();  
    </script>  
</body>  
</html>